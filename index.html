<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Major Express - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href='data:application/json;charset=utf-8,{"name":"Major Express","short_name":"MajorExp","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#0f172a","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2830/2830305.png","sizes":"512x512","type":"image/png"}]}'>
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2830/2830305.png">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <style>
        /* Mobile-first map height */
        #map { height: 300px; width: 100%; border-radius: 12px; overflow: hidden; }
        @media (min-width: 1024px) {
            #map { height: 550px; }
        }

        .drag-handle { cursor: grab; touch-action: none; }
        .drag-handle:active { cursor: grabbing; }
        
        .address-item { transition: all 0.2s ease; }
        .address-item.highlighted { 
            background: rgba(249, 115, 22, 0.3) !important; 
            border: 2px solid #f97316;
            transform: scale(1.02);
        }
        
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .recording { 
            animation: recording-pulse 1s infinite; 
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        @keyframes recording-pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .voice-wave {
            display: flex;
            align-items: center;
            gap: 3px;
            height: 20px;
        }
        .voice-wave span {
            width: 3px;
            background: white;
            border-radius: 2px;
            animation: wave 0.5s infinite ease-in-out;
        }
        .voice-wave span:nth-child(1) { animation-delay: 0s; height: 8px; }
        .voice-wave span:nth-child(2) { animation-delay: 0.1s; height: 16px; }
        .voice-wave span:nth-child(3) { animation-delay: 0.2s; height: 12px; }
        .voice-wave span:nth-child(4) { animation-delay: 0.3s; height: 18px; }
        .voice-wave span:nth-child(5) { animation-delay: 0.4s; height: 10px; }
        @keyframes wave {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.5); }
        }
        
        .toast-enter { transform: translateY(-100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(-100%); opacity: 0; transition: all 0.3s ease-in; }
        
        .address-completed {
            opacity: 0.6;
            background: rgba(255, 255, 255, 0.02) !important;
        }
        .address-completed .text-white {
            text-decoration: line-through;
            color: rgba(255, 255, 255, 0.5);
        }
        .notes-input {
            transition: all 0.2s;
        }
        .notes-input:focus {
            background: rgba(0, 0, 0, 0.3);
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }

        .ymaps-2-1-79-map { border-radius: 12px; }
        
        .priority-urgent { 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            animation: urgent-pulse 1.5s infinite;
        }
        @keyframes urgent-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        
        .time-critical { color: #ef4444; font-weight: bold; }
        .time-soon { color: #f59e0b; }
        .time-ok { color: #22c55e; }
        
        .filter-btn.active {
            background: rgba(249, 115, 22, 0.3);
            border-color: #f97316;
        }
        
        .eta-badge {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(0,0,0,0.3);
        }
        
        .geo-btn.loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Safe area for iPhones */
        body {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
    <div class="container mx-auto px-4 py-4 max-w-5xl">
        <!-- Compact Mobile Header -->
        <header class="flex items-center justify-between mb-6 bg-white/5 backdrop-blur-sm p-3 rounded-2xl border border-white/10">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-r from-orange-500 to-red-500 rounded-xl flex items-center justify-center shadow-lg">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight">Major Express</h1>
                    <p class="text-blue-300 text-xs">–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleHistoryModal()" class="bg-white/10 hover:bg-white/20 p-2 rounded-xl transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="flex flex-col-reverse lg:grid lg:grid-cols-2 gap-6">
            
            <!-- Left Panel (Controls) -->
            <div class="space-y-4">
                
                <!-- 1. Address Input & Controls -->
                <div class="space-y-4">
                    <!-- Start Point -->
                    <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4 border border-white/5">
                        <div class="flex gap-2">
                            <div class="flex-1 relative">
                                <div class="absolute left-3 top-1/2 -translate-y-1/2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-xs font-bold">–ê</div>
                                <input type="text" id="startAddress" placeholder="–û—Ç–∫—É–¥–∞ —Å—Ç–∞—Ä—Ç?" 
                                    class="w-full bg-white/10 border border-white/20 rounded-xl pl-11 pr-3 py-3 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm">
                            </div>
                            <button onclick="getMyLocation()" id="geoBtn" class="geo-btn bg-blue-500 hover:bg-blue-600 text-white px-3 rounded-xl transition-colors flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </button>
                            <button onclick="setStartPoint()" class="bg-green-500 hover:bg-green-600 text-white px-3 rounded-xl font-bold">‚úì</button>
                        </div>
                        <div id="startPointDisplay" class="mt-2 text-green-400 text-xs hidden pl-1"></div>
                    </div>

                    <!-- Voice Input -->
                    <div class="bg-gradient-to-r from-red-500/20 to-orange-500/20 backdrop-blur-sm rounded-2xl p-1 border border-red-500/30">
                        <button onclick="toggleVoiceRecording()" id="voiceBtn" 
                            class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white py-4 rounded-xl font-bold text-lg transition-all shadow-lg flex flex-col items-center justify-center gap-1 min-h-[80px]">
                            <div class="flex items-center gap-2">
                                <svg id="micIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                                <span id="voiceBtnText">–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥</span>
                            </div>
                            <div id="voiceWave" class="voice-wave hidden"><span></span><span></span><span></span><span></span><span></span></div>
                            <span class="text-xs font-normal opacity-70" id="voiceStatusShort">–ù–∞–∂–º–∏—Ç–µ –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å</span>
                        </button>
                        <div id="voiceStatus" class="hidden"></div> <!-- Hidden logic container -->
                    </div>

                    <!-- Manual Input -->
                    <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
                        <div class="flex gap-2 mb-3">
                            <div class="flex-1 flex gap-1 bg-white/10 border border-white/20 rounded-xl p-1 focus-within:ring-2 focus-within:ring-orange-500">
                                <input type="text" id="addressInput" placeholder="–ê–¥—Ä–µ—Å..." 
                                    class="flex-1 bg-transparent border-none text-white placeholder-white/50 px-3 py-2 focus:outline-none min-w-0 text-sm"
                                    onkeypress="if(event.key==='Enter') addAddress()">
                                <div class="w-px bg-white/20 my-1"></div>
                                <input type="time" id="timeInput" class="bg-transparent border-none text-white/80 text-xs px-1 focus:outline-none cursor-pointer w-16">
                                <div class="w-px bg-white/20 my-1"></div>
                                <select id="priorityInput" class="bg-transparent border-none text-white/80 text-lg px-1 focus:outline-none cursor-pointer w-10 appearance-none text-center">
                                    <option value="normal" class="bg-slate-800">‚≠ê</option>
                                    <option value="urgent" class="bg-slate-800">üî•</option>
                                </select>
                            </div>
                            <button onclick="addAddress()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 rounded-xl shadow-lg">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="bg-gradient-to-r from-blue-600/20 to-purple-600/20 backdrop-blur-sm rounded-2xl p-4 border border-blue-500/20">
                    <div class="flex justify-between items-end mb-2">
                        <div>
                            <div class="flex items-baseline gap-2">
                                <span class="text-3xl font-bold text-white" id="statCompleted">0</span>
                                <span class="text-white/50 text-sm">–∏–∑ <span id="statTotal">0</span></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-white text-sm font-bold" id="statPercent">0%</p>
                            <p class="text-white/40 text-[10px]" id="statETA">-</p>
                        </div>
                    </div>
                    <div class="w-full bg-black/30 h-2 rounded-full overflow-hidden">
                        <div id="statBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Address List -->
                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-md font-semibold text-white flex items-center gap-2">
                            –ê–¥—Ä–µ—Å–∞ (<span id="addressCount">0</span>)
                        </h2>
                        <div class="flex gap-3">
                            <button onclick="copyAddressList()" class="text-blue-400 hover:text-blue-300" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
                            <button onclick="clearAllAddresses()" class="text-red-400 hover:text-red-300 text-sm">–û—á–∏—Å—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <!-- Search & Filter -->
                    <div class="mb-3 space-y-2">
                        <input type="text" id="searchAddresses" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="filterAddresses()"
                            class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm placeholder-white/30 focus:outline-none focus:ring-1 focus:ring-orange-500">
                        <div class="flex gap-1 overflow-x-auto pb-1">
                            <button onclick="setFilter('all')" class="filter-btn active flex-shrink-0 text-xs bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-white/70 whitespace-nowrap" data-filter="all">–í—Å–µ</button>
                            <button onclick="setFilter('active')" class="filter-btn flex-shrink-0 text-xs bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-white/70 whitespace-nowrap" data-filter="active">–í —Ä–∞–±–æ—Ç–µ</button>
                            <button onclick="setFilter('urgent')" class="filter-btn flex-shrink-0 text-xs bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-orange-400 whitespace-nowrap" data-filter="urgent">üî• –°—Ä–æ—á–Ω—ã–µ</button>
                        </div>
                    </div>
                    
                    <div id="addressList" class="space-y-2 max-h-[400px] overflow-y-auto pr-1 pb-10">
                        <p class="text-white/50 text-center py-4 text-sm">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</p>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="grid gap-3 sticky bottom-4 z-30">
                    <button onclick="optimizeRoute()" id="optimizeBtn" 
                        class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white py-3 rounded-xl font-bold text-md shadow-xl shadow-black/50">
                        –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç üöÄ
                    </button>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="openInYandexMaps()" class="bg-yellow-500 hover:bg-yellow-600 text-black py-3 rounded-xl font-medium text-sm flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                            –Ø–Ω–¥–µ–∫—Å
                        </button>
                        <button onclick="openInGoogleMaps()" class="bg-white hover:bg-gray-100 text-gray-800 py-3 rounded-xl font-medium text-sm flex items-center justify-center gap-2">
                            Google
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Panel (Map) -->
            <div class="space-y-4">
                <!-- Map -->
                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-1 relative shadow-xl">
                    <button id="clearHistoryBtn" onclick="clearHistoryPreview()" class="absolute top-14 right-4 z-[400] bg-white text-slate-800 px-3 py-1.5 rounded-lg shadow-lg text-xs font-bold hidden border border-slate-200">
                        –°–∫—Ä—ã—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                    </button>
                    <div id="map"></div>
                </div>

                <!-- Text Route -->
                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-md font-semibold text-white">–ú–∞—Ä—à—Ä—É—Ç</h2>
                        <div class="text-xs text-white/50" id="totalDistance">-</div>
                    </div>
                    <div id="optimizedRoute" class="space-y-2 max-h-60 overflow-y-auto text-sm">
                        <p class="text-white/50 text-center py-2">–ù–µ—Ç –º–∞—Ä—à—Ä—É—Ç–∞</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-slate-800 rounded-2xl p-6 text-center border border-white/10 shadow-2xl">
                <div class="w-10 h-10 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p class="text-white text-sm" id="loadingText">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 rounded-2xl w-full max-w-lg max-h-[80vh] flex flex-col shadow-2xl border border-white/10">
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-slate-800 rounded-t-2xl">
                <h2 class="text-lg font-bold text-white">–ò—Å—Ç–æ—Ä–∏—è</h2>
                <button onclick="toggleHistoryModal()" class="text-white/50 hover:text-white p-2">‚úï</button>
            </div>
            <div class="overflow-y-auto p-4 flex-1" id="historyContent"></div>
            <div class="p-3 border-t border-white/10 bg-slate-800 rounded-b-2xl">
                <button onclick="toggleHistoryModal()" class="w-full bg-white/10 text-white py-3 rounded-xl font-medium">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Toast Container (Centered Top for Mobile) -->
    <div id="toastContainer" class="fixed top-4 left-0 right-0 flex flex-col items-center gap-2 z-[100] pointer-events-none px-4"></div>

    <audio id="successSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleVMWJImtwaVnPBsbZ5+9rG9FGyFQj7yzf1kwFjJpn7qmZT4UJ1mYtaRlQBglWJKwoGVBGCZXkK2dZEIZJ1eQrJxjQhkn" type="audio/wav">
    </audio>

    <script>
        // --- Global Variables ---
        let myMap = null;
        let addresses = [];
        let startPoint = null;
        let markers = [];
        let routeLine = null;
        let historyMarkers = [];
        let addressHistory = [];
        let currentFilter = 'all';

        // --- Initialization ---
        ymaps.ready(init);

        function init() {
            myMap = new ymaps.Map("map", {
                center: [55.7558, 37.6173],
                zoom: 10,
                controls: ['zoomControl', 'geolocationControl', 'typeSelector']
            });
            loadSavedData();
        }

        // --- Geolocation ---
        function getMyLocation() {
            const btn = document.getElementById('geoBtn');
            btn.classList.add('loading');
            
            if (!navigator.geolocation) {
                showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ GPS', 'warning');
                btn.classList.remove('loading');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    try {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π Nominatim –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`, {
                            headers: { 'User-Agent': 'MajorExpressRouteOptimizer/1.0' }
                        });
                        const data = await response.json();
                        
                        let address = '–ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
                        if (data && data.display_name) {
                            // –ë–µ—Ä–µ–º —É–ª–∏—Ü—É –∏ –Ω–æ–º–µ—Ä –¥–æ–º–∞
                            const addr = data.address;
                            if (addr.road) {
                                address = addr.road;
                                if (addr.house_number) address += ', ' + addr.house_number;
                            } else {
                                const parts = data.display_name.split(',').slice(0, 2);
                                address = parts.join(',').trim();
                            }
                        }
                        
                        document.getElementById('startAddress').value = address;
                        startPoint = { address, lat, lng };
                        document.getElementById('startPointDisplay').textContent = `‚úì ${address}`;
                        document.getElementById('startPointDisplay').classList.remove('hidden');
                        saveData();
                        updateMap();
                        showToast('–ù–∞–π–¥–µ–Ω–æ!', 'success');
                    } catch (e) {
                        startPoint = { address: 'GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã', lat, lng };
                        document.getElementById('startAddress').value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                        saveData();
                        updateMap();
                    }
                    btn.classList.remove('loading');
                },
                (error) => {
                    btn.classList.remove('loading');
                    showToast('–û—à–∏–±–∫–∞ GPS. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.', 'warning');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        // --- Address Parsing & Geocoding ---
        function normalizeAddress(address) {
            let lower = address.trim().toLowerCase();
            lower = lower.replace(/^(—É–ª–∏—Ü–∞|—É–ª\.?|–ø—Ä–æ—Å–ø–µ–∫—Ç|–ø—Ä\.?|–ø—Ä-—Ç|–ø–µ—Ä–µ—É–ª–æ–∫|–ø–µ—Ä\.?|–±—É–ª—å–≤–∞—Ä|–±-—Ä|–±—É–ª\.?|—à–æ—Å—Å–µ|—à\.?|–ø—Ä–æ–µ–∑–¥|–ø—Ä-–¥|–Ω–∞–±–µ—Ä–µ–∂–Ω–∞—è|–Ω–∞–±\.?|–ø–ª–æ—â–∞–¥—å|–ø–ª\.?)\s+/i, '');
            lower = lower.replace(/–¥–æ–º\s+/g, '');
            return lower.charAt(0).toUpperCase() + lower.slice(1);
        }

        function generateAddressVariants(address) {
            const variants = [];
            const base = normalizeAddress(address);
            
            function transliterate(str) {
                const map = {'–∞':'a', '–±':'b', '–≤':'v', '–≥':'g', '–¥':'d', '–µ':'e', '–∂':'zh', '–∑':'z', '–∏':'i', '–∫':'k', '–ª':'l', '–º':'m', '–Ω':'n', '–æ':'o', '–ø':'p', '—Ä':'r', '—Å':'s', '—Ç':'t', '—É':'u', '—Ñ':'f', '—Ö':'h', '—Ü':'c', '—á':'ch', '—à':'sh', '—â':'shch', '—ç':'e', '—é':'yu', '—è':'ya'};
                return str.replace(/([0-9]+)\s*([–∞-—è])/ig, (match, num, char) => {
                    return map[char.toLowerCase()] ? `${num}${map[char.toLowerCase()].toUpperCase()}` : match;
                });
            }

            let templates = [base];

            // 1. –°—Ç—Ä–æ–µ–Ω–∏–µ / –ö–æ—Ä–ø—É—Å (67—Å14, 67–∫14)
            const strRegex = /(\d+)\s*(?:—Å—Ç—Ä–æ–µ–Ω–∏–µ|—Å—Ç—Ä\.?|—Å\.?)\s*(\d+)/i;
            const korpRegex = /(\d+)\s*(?:–∫–æ—Ä–ø—É—Å|–∫–æ—Ä–ø\.?|–∫\.?)\s*(\d+)/i;

            if (strRegex.test(base)) {
                templates.push(base.replace(strRegex, '$1—Å$2'));
                templates.push(base.replace(strRegex, '$1 —Å$2'));
                templates.push(base.replace(strRegex, '$1 —Å—Ç—Ä $2'));
            }
            
            if (korpRegex.test(base)) {
                templates.push(base.replace(korpRegex, '$1–∫$2'));
                templates.push(base.replace(korpRegex, '$1 –∫$2'));
            }

            // 2. –ë—É–∫–≤—ã (14–ê)
            const letterRegex = /(\d+)\s*([–∞-—è–ê-–Øa-zA-Z])/;
            if (letterRegex.test(base)) {
                templates.push(base.replace(letterRegex, '$1$2'));
                templates.push(base.replace(letterRegex, '$1 $2'));
            }

            templates.forEach(tpl => {
                variants.push(`–ú–æ—Å–∫–≤–∞, ${tpl}`);
                variants.push(`–ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ ${tpl}`);
                variants.push(`Moscow, ${transliterate(tpl)}`);
            });

            // –•–∞–∫ –¥–ª—è —Å/–∫ –ø—É—Ç–∞–Ω–∏—Ü—ã
            if (base.includes('—Å—Ç—Ä–æ–µ–Ω–∏–µ') || base.includes('—Å—Ç—Ä')) {
                const swapped = base.replace(/(?:—Å—Ç—Ä–æ–µ–Ω–∏–µ|—Å—Ç—Ä\.?)/i, '–∫–æ—Ä–ø—É—Å');
                variants.push(`–ú–æ—Å–∫–≤–∞, ${swapped}`);
            }

            return [...new Set(variants)];
        }

        async function geocodeAddress(address) {
            const variants = generateAddressVariants(address);
            
            for (const variant of variants) {
                const result = await tryNominatim(variant);
                if (result) return result;
                await new Promise(r => setTimeout(r, 200));
            }
            
            const photonResult = await tryPhoton(address);
            if (photonResult) return photonResult;
            
            return null;
        }

        async function tryNominatim(fullAddress) {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1&addressdetails=1&countrycodes=ru`;
            try {
                const response = await fetch(url, { headers: { 'User-Agent': 'MajorExpressApp/1.0' } });
                const data = await response.json();
                if (data && data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), displayName: data[0].display_name };
                }
                return null;
            } catch (e) { return null; }
        }

        async function tryPhoton(address) {
            const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(address + ", –ú–æ—Å–∫–≤–∞")}&limit=1&lang=ru`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data && data.features && data.features.length > 0) {
                    const coords = data.features[0].geometry.coordinates;
                    return { lat: coords[1], lng: coords[0], displayName: data.features[0].properties.name };
                }
                return null;
            } catch (e) { return null; }
        }

        // --- Core Logic ---
        async function setStartPoint() {
            const address = document.getElementById('startAddress').value.trim();
            if (!address) return;
            showLoading('–ò—â—É —Å—Ç–∞—Ä—Ç...');
            const coords = await geocodeAddress(address);
            hideLoading();
            if (coords) {
                startPoint = { address, ...coords };
                document.getElementById('startPointDisplay').textContent = `‚úì ${address}`;
                document.getElementById('startPointDisplay').classList.remove('hidden');
                saveData();
                updateMap();
            } else {
                showToast('–ê–¥—Ä–µ—Å —Å—Ç–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
            }
        }

        async function addAddress() {
            const input = document.getElementById('addressInput');
            const address = input.value.trim();
            const time = document.getElementById('timeInput').value;
            const priority = document.getElementById('priorityInput').value;
            
            if (!address) return;
            if (addresses.find(a => a.address.toLowerCase() === address.toLowerCase())) {
                showToast('–ê–¥—Ä–µ—Å —É–∂–µ –µ—Å—Ç—å', 'warning');
                return;
            }

            showLoading('–ò—â—É...');
            const coords = await geocodeAddress(address);
            hideLoading();

            if (coords) {
                const lastVisit = checkHistory(address);
                if (lastVisit) showToast(`–ë—ã–ª ${lastVisit}`, 'info');

                const newAddr = { address, ...coords, time, priority, id: Date.now() };
                addresses.push(newAddr);
                addToHistory(newAddr);
                
                input.value = '';
                document.getElementById('timeInput').value = '';
                document.getElementById('priorityInput').value = 'normal';
                
                updateAddressList();
                updateMap();
                saveData();
                playSuccessSound();
                showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ!', 'success');
            } else {
                showToast('–ù–µ –Ω–∞—à–µ–ª –∞–¥—Ä–µ—Å', 'warning');
            }
        }

        // --- Voice Logic ---
        let recognition = null;
        let isRecording = false;

        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('voiceBtnText').textContent = '–ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–æ–ª–æ—Å–∞';
                return;
            }
            recognition = new SpeechRecognition();
            recognition.lang = 'ru-RU';
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isRecording = true;
                const btn = document.getElementById('voiceBtn');
                btn.classList.add('recording');
                document.getElementById('voiceBtnText').textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
                document.getElementById('voiceWave').classList.remove('hidden');
                document.getElementById('micIcon').classList.add('hidden');
            };

            recognition.onresult = async (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript;
                await processVoiceAddress(transcript);
            };

            recognition.onend = () => {
                if (isRecording) recognition.start();
                else stopVoiceUI();
            };
        }

        function stopVoiceUI() {
            const btn = document.getElementById('voiceBtn');
            btn.classList.remove('recording');
            document.getElementById('voiceBtnText').textContent = '–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥';
            document.getElementById('voiceWave').classList.add('hidden');
            document.getElementById('micIcon').classList.remove('hidden');
        }

        function toggleVoiceRecording() {
            if (!recognition) initSpeechRecognition();
            if (!recognition) return;

            if (isRecording) {
                isRecording = false;
                recognition.stop();
                stopVoiceUI();
            } else {
                recognition.start();
            }
        }

        function extractTimeFromSpeech(text) {
            const timeRegex = /(?:–∫|–≤|–¥–æ|–Ω–∞)\s+(\d{1,2})(?:[:\s](\d{2}))?(?:\s*—á(?:–∞—Å–æ–≤)?)?/i;
            const match = text.match(timeRegex);
            if (match) {
                let h = parseInt(match[1]);
                let m = match[2] ? parseInt(match[2]) : 0;
                const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                return { time: timeStr, address: text.replace(match[0], '').trim() };
            }
            return { time: null, address: text };
        }

        async function processVoiceAddress(rawText) {
            if (!rawText || rawText.length < 3) return;
            
            const { time, address: cleanAddress } = extractTimeFromSpeech(rawText);
            let address = cleanAddress.charAt(0).toUpperCase() + cleanAddress.slice(1);
            
            let priority = 'normal';
            if (/—Å—Ä–æ—á–Ω|–±—ã—Å—Ç—Ä|–≤–∞–∂–Ω/i.test(address)) {
                priority = 'urgent';
                address = address.replace(/—Å—Ä–æ—á–Ω\w*|–±—ã—Å—Ç—Ä\w*|–≤–∞–∂–Ω\w*/gi, '').trim();
            }

            if (addresses.find(a => a.address.toLowerCase().includes(address.toLowerCase()))) {
                showToast('–£–∂–µ –µ—Å—Ç—å', 'warning');
                return;
            }

            document.getElementById('voiceStatusShort').textContent = `–ò—â—É: ${address}...`;
            const coords = await geocodeAddress(address);

            if (coords) {
                const newAddr = { address, ...coords, time, priority, id: Date.now() };
                addresses.push(newAddr);
                addToHistory(newAddr);
                updateAddressList();
                updateMap();
                saveData();
                playSuccessSound();
                document.getElementById('voiceStatusShort').textContent = `–î–æ–±–∞–≤–ª–µ–Ω: ${address}`;
                showToast(`+ ${address}`, 'success');
                
                // Auto optimize if start point exists
                if (startPoint) optimizeRoute();
            } else {
                document.getElementById('voiceStatusShort').textContent = `–ù–µ –Ω–∞—à–µ–ª: ${address}`;
                showToast('–ù–µ –Ω–∞—à–µ–ª –∞–¥—Ä–µ—Å', 'warning');
            }
        }

        // --- UI & Helpers ---
        function showToast(message, type) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bg = type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-orange-500' : 'bg-blue-600';
            toast.className = `toast-enter flex items-center gap-2 ${bg} text-white px-4 py-3 rounded-xl shadow-xl backdrop-blur-sm pointer-events-auto text-sm font-medium min-w-[200px] justify-center`;
            toast.innerHTML = message;
            container.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.remove('toast-enter'); toast.classList.add('toast-enter-active'); });
            setTimeout(() => { toast.remove(); }, 3000);
        }

        function playSuccessSound() {
            document.getElementById('successSound').play().catch(()=>{});
        }

        function moveAddressUp(id) {
            const index = addresses.findIndex(a => a.id === id);
            if (index > 0) {
                [addresses[index - 1], addresses[index]] = [addresses[index], addresses[index - 1]];
                saveData(); updateAddressList(); drawRouteManually();
            }
        }

        function moveAddressDown(id) {
            const index = addresses.findIndex(a => a.id === id);
            if (index < addresses.length - 1) {
                [addresses[index], addresses[index + 1]] = [addresses[index + 1], addresses[index]];
                saveData(); updateAddressList(); drawRouteManually();
            }
        }

        function updateAddressList() {
            const list = document.getElementById('addressList');
            const filter = currentFilter;
            let filtered = addresses;

            if (filter === 'active') filtered = addresses.filter(a => !a.completed);
            if (filter === 'urgent') filtered = addresses.filter(a => a.priority === 'urgent' && !a.completed);
            
            const search = document.getElementById('searchAddresses').value.toLowerCase();
            if (search) filtered = filtered.filter(a => a.address.toLowerCase().includes(search));

            document.getElementById('addressCount').textContent = addresses.length;
            updateStats();

            if (filtered.length === 0) {
                list.innerHTML = '<p class="text-white/50 text-center py-4 text-sm">–ù–µ—Ç –∞–¥—Ä–µ—Å–æ–≤</p>';
                return;
            }

            list.innerHTML = filtered.map((addr, i) => {
                const globalIndex = addresses.findIndex(a => a.id === addr.id);
                const isFirst = globalIndex === 0;
                const isLast = globalIndex === addresses.length - 1;
                const phone = extractPhone(addr.notes);

                return `
                <div class="address-item relative flex flex-col gap-2 bg-white/5 rounded-xl p-3 ${addr.completed ? 'address-completed' : ''} ${addr.id === highlightedAddressId ? 'highlighted' : ''}">
                    <div class="flex gap-3">
                        <div class="flex flex-col gap-1 justify-center pt-1">
                             ${!addr.completed ? `
                                <button onclick="moveAddressUp(${addr.id})" class="p-1 bg-white/5 rounded text-white/50 hover:text-white hover:bg-white/20 ${isFirst ? 'opacity-0 pointer-events-none' : ''}">‚ñ≤</button>
                                <button onclick="moveAddressDown(${addr.id})" class="p-1 bg-white/5 rounded text-white/50 hover:text-white hover:bg-white/20 ${isLast ? 'opacity-0 pointer-events-none' : ''}">‚ñº</button>
                             ` : ''}
                        </div>
                        
                        <button onclick="toggleAddressStatus(${addr.id})" class="mt-1 w-8 h-8 flex-shrink-0 ${addr.completed ? 'bg-green-500' : addr.priority === 'urgent' ? 'priority-urgent' : 'bg-blue-600'} rounded-full flex items-center justify-center text-white font-bold text-sm shadow-lg transition-all active:scale-90">
                            ${addr.completed ? '‚úì' : (globalIndex + 1)}
                        </button>

                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <div class="text-sm font-medium text-white break-words leading-snug ${addr.completed ? 'line-through text-white/50' : ''}">${addr.address}</div>
                                <div class="flex gap-1 ml-2">
                                    ${phone ? `<a href="tel:${phone}" class="bg-green-500/20 text-green-400 p-1.5 rounded-lg">üìû</a>` : ''}
                                    <button onclick="removeAddress(${addr.id})" class="bg-red-500/20 text-red-400 p-1.5 rounded-lg">‚úï</button>
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-2 mt-2 items-center">
                                <div class="bg-black/20 rounded-lg px-2 py-1 flex items-center gap-1">
                                    <span class="text-xs text-white/50">–í—Ä–µ–º—è:</span>
                                    <input type="time" value="${addr.time || ''}" onchange="updateTime(${addr.id}, this.value)" class="bg-transparent text-white text-xs w-12 p-0 border-none focus:ring-0">
                                </div>
                                ${addr.priority === 'urgent' ? '<span class="text-xs bg-red-500/20 text-red-400 px-2 py-0.5 rounded">üî• –°—Ä–æ—á–Ω–æ</span>' : ''}
                            </div>
                            
                            <input type="text" value="${addr.notes || ''}" onchange="updateNotes(${addr.id}, this.value)" 
                                placeholder="–ó–∞–º–µ—Ç–∫–∏ (–∫–æ–¥, —ç—Ç–∞–∂)..." class="mt-2 w-full bg-white/5 border border-white/10 rounded px-2 py-1 text-xs text-white/70 focus:bg-black/30 outline-none">
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // --- Helper Functions ---
        function extractPhone(str) {
            if(!str) return null;
            const match = str.match(/(\+7|8|9)[\d\-\(\)\s]{9,}/);
            return match ? match[0].replace(/[^\d\+]/g, '') : null;
        }

        let highlightedAddressId = null;
        function highlightAddress(id) {
            highlightedAddressId = id;
            updateAddressList();
            setTimeout(() => { highlightedAddressId = null; updateAddressList(); }, 2000);
            document.getElementById('addressList').querySelector(`[onclick="removeAddress(${id})"]`)?.scrollIntoView({block: 'center', behavior: 'smooth'});
        }

        function updateStats() {
            const total = addresses.length;
            const done = addresses.filter(a => a.completed).length;
            const pct = total ? Math.round(done/total*100) : 0;
            document.getElementById('statCompleted').textContent = done;
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPercent').textContent = pct + '%';
            document.getElementById('statBar').style.width = pct + '%';
        }

        function saveData() {
            localStorage.setItem('majorExpressAddresses', JSON.stringify(addresses));
            if (startPoint) localStorage.setItem('majorExpressStart', JSON.stringify(startPoint));
        }

        function loadSavedData() {
            try {
                const s = localStorage.getItem('majorExpressAddresses');
                if (s) addresses = JSON.parse(s);
                const start = localStorage.getItem('majorExpressStart');
                if (start) {
                    startPoint = JSON.parse(start);
                    document.getElementById('startAddress').value = startPoint.address;
                    document.getElementById('startPointDisplay').textContent = `‚úì ${startPoint.address}`;
                    document.getElementById('startPointDisplay').classList.remove('hidden');
                }
                
                const hist = localStorage.getItem('majorExpressHistory');
                if (hist) addressHistory = JSON.parse(hist);

                updateAddressList();
                updateMap();
            } catch(e) {}
        }

        // --- Map & Routing ---
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function drawRouteManually() {
            if (!myMap || !startPoint) return;
            if (routeLine) { myMap.geoObjects.remove(routeLine); routeLine = null; }
            
            const points = [ [startPoint.lat, startPoint.lng], ...addresses.map(a => [a.lat, a.lng]) ];
            routeLine = new ymaps.Polyline(points, {}, { strokeColor: '#f97316', strokeWidth: 4, strokeStyle: 'solid' });
            myMap.geoObjects.add(routeLine);
            updateMapMarkers();
            
            let totalDist = 0;
            for(let i=0; i<points.length-1; i++) {
                totalDist += calculateDistance(points[i][0], points[i][1], points[i+1][0], points[i+1][1]);
            }
            document.getElementById('totalDistance').textContent = `${totalDist.toFixed(1)} –∫–º`;
        }

        function updateMap() {
            if (!myMap) return;
            myMap.geoObjects.removeAll();
            if (routeLine) myMap.geoObjects.add(routeLine);
            updateMapMarkers();
        }

        function updateMapMarkers() {
            if (startPoint) {
                const startPlacemark = new ymaps.Placemark([startPoint.lat, startPoint.lng], { hintContent: '–°—Ç–∞—Ä—Ç' }, { preset: 'islands#greenCircleDotIcon' });
                myMap.geoObjects.add(startPlacemark);
            }
            
            addresses.forEach((addr, i) => {
                const preset = addr.completed ? 'islands#grayIcon' : addr.priority === 'urgent' ? 'islands#redIcon' : 'islands#blueIcon';
                const pm = new ymaps.Placemark([addr.lat, addr.lng], {
                    iconContent: i + 1,
                    hintContent: addr.address,
                    balloonContent: `<strong>${addr.address}</strong><br>${addr.notes || ''}`
                }, { preset: preset });
                pm.events.add('click', () => highlightAddress(addr.id));
                myMap.geoObjects.add(pm);
            });

            if (addresses.length || startPoint) {
                myMap.setBounds(myMap.geoObjects.getBounds(), { checkZoomRange: true, zoomMargin: 30 });
            }
        }

        // --- Optimization ---
        function optimizeRoute() {
            if (addresses.length < 1 || !startPoint) { showToast('–ù—É–∂–µ–Ω —Å—Ç–∞—Ä—Ç –∏ –∞–¥—Ä–µ—Å–∞', 'warning'); return; }
            
            // Simple Nearest Neighbor + Time constraint sorting
            // 1. Separate timed & untimed
            let timed = addresses.filter(a => a.time && !a.completed).sort((a,b) => a.time.localeCompare(b.time));
            let others = addresses.filter(a => !a.time && !a.completed);
            let completed = addresses.filter(a => a.completed);

            // 2. Sort 'others' by nearest neighbor starting from startPoint
            let currentLoc = startPoint;
            let sortedOthers = [];
            
            while (others.length > 0) {
                let nearestIdx = 0;
                let minDst = Infinity;
                for(let i=0; i<others.length; i++) {
                    const dst = calculateDistance(currentLoc.lat, currentLoc.lng, others[i].lat, others[i].lng);
                    if (dst < minDst) { minDst = dst; nearestIdx = i; }
                }
                sortedOthers.push(others[nearestIdx]);
                currentLoc = others[nearestIdx];
                others.splice(nearestIdx, 1);
            }

            // 3. Merge: Timed -> Sorted Others (Priority logic can be added here)
            // Simple merge: Urgents first in sortedOthers
            let urgents = sortedOthers.filter(a => a.priority === 'urgent');
            let normals = sortedOthers.filter(a => a.priority !== 'urgent');
            
            // Final Order: Timed -> Urgent (Nearest) -> Normal (Nearest) -> Completed
            // Note: ideally timed should be inserted into the path, but for courier simplicity "Time Bound" usually means "Go there first or at specific time".
            // Let's put timed first for now.
            
            addresses = [...timed, ...urgents, ...normals, ...completed];
            saveData();
            updateAddressList();
            drawRouteManually();
            showToast('–ú–∞—Ä—à—Ä—É—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
            
            // Text Route
            document.getElementById('optimizedRoute').innerHTML = addresses.map((a, i) => `
                <div class="flex gap-2 items-center text-xs text-white/80 ${a.completed ? 'opacity-50' : ''}">
                    <span class="font-bold text-orange-400">${i+1}.</span>
                    <span>${a.address}</span>
                    ${a.time ? `<span class="text-green-400 ml-auto">${a.time}</span>` : ''}
                </div>
            `).join('');
        }

        // --- External Maps ---
        function openInYandexMaps() {
             if (!startPoint) return;
             const pts = [startPoint, ...addresses.filter(a=>!a.completed)];
             const url = `https://yandex.ru/maps/?rtext=${pts.map(p=>`${p.lat},${p.lng}`).join('~')}&rtt=auto`;
             window.open(url, '_blank');
        }

        function openInGoogleMaps() {
             if (!startPoint) return;
             const pts = [startPoint, ...addresses.filter(a=>!a.completed)];
             const url = `https://www.google.com/maps/dir/${pts.map(p=>`${p.lat},${p.lng}`).join('/')}`;
             window.open(url, '_blank');
        }
        
        // --- Simple Actions ---
        function removeAddress(id) { addresses = addresses.filter(a=>a.id!==id); saveData(); updateAddressList(); drawRouteManually(); }
        function clearAllAddresses() { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å?')) { addresses = []; saveData(); updateAddressList(); updateMap(); } }
        function toggleAddressStatus(id) { const a = addresses.find(x=>x.id===id); if(a){ a.completed=!a.completed; saveData(); updateAddressList(); drawRouteManually(); } }
        function updateTime(id, val) { const a = addresses.find(x=>x.id===id); if(a){ a.time=val; saveData(); } }
        function updateNotes(id, val) { const a = addresses.find(x=>x.id===id); if(a){ a.notes=val; saveData(); } }
        function setFilter(f) { currentFilter = f; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); document.querySelector(`[data-filter="${f}"]`).classList.add('active'); updateAddressList(); }
        function filterAddresses() { updateAddressList(); }
        function copyAddressList() {
            const txt = addresses.map((a,i) => `${i+1}. ${a.address} ${a.time?'('+a.time+')':''} ${a.notes||''}`).join('\n');
            navigator.clipboard.writeText(txt);
            showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ', 'success');
        }
        
        // --- History ---
        function checkHistory(addr) { const d = new Date().toLocaleDateString('ru-RU'); const f = addressHistory.find(h=>h.address===addr && h.date!==d); return f ? f.date : null; }
        function addToHistory(addr) { 
            const d = new Date().toLocaleDateString('ru-RU');
            if(!addressHistory.find(h=>h.address===addr.address && h.date===d)) {
                addressHistory.unshift({...addr, date:d});
                localStorage.setItem('majorExpressHistory', JSON.stringify(addressHistory));
            }
        }
        function toggleHistoryModal() {
            const m = document.getElementById('historyModal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                const c = document.getElementById('historyContent');
                if(!addressHistory.length) { c.innerHTML = '<p class="text-white/50 text-center">–ü—É—Å—Ç–æ</p>'; return; }
                // Group by date
                const grp = {}; addressHistory.forEach(a=>{ if(!grp[a.date]) grp[a.date]=[]; grp[a.date].push(a); });
                c.innerHTML = Object.keys(grp).map(d => `
                    <div class="mb-4">
                        <div class="text-blue-400 font-bold mb-2 text-sm sticky top-0 bg-slate-900 py-1">${d}</div>
                        ${grp[d].map(a => `
                            <div class="flex justify-between items-center bg-white/5 p-2 rounded mb-1">
                                <span class="text-white text-xs">${a.address}</span>
                                <button onclick='addHistoryItem(${JSON.stringify(a).replace(/'/g, "&#39;")})' class="text-green-400 text-xs border border-green-500/30 px-2 py-1 rounded hover:bg-green-500/20">+</button>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            }
        }
        function addHistoryItem(item) {
             if(addresses.find(a=>a.address===item.address)) { showToast('–£–∂–µ –µ—Å—Ç—å', 'warning'); return; }
             const newAddr = {...item, id:Date.now(), completed:false};
             addresses.push(newAddr); saveData(); updateAddressList(); updateMap(); showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ', 'success');
        }
        function clearHistoryPreview() { /* Placeholder if needed */ }
        function showLoading(txt) { document.getElementById('loadingText').textContent=txt; document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

        document.addEventListener('DOMContentLoaded', initSpeechRecognition);
    </script>
</body>
</html>
